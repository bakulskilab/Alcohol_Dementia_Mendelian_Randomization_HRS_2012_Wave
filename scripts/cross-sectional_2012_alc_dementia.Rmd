---
title: "cross-sectional_alc_dementia"
author: "Kyle Abraham Campbell"
date: "11/1/2021"
output: html_document
---

```{r setup, include=FALSE}
library(devtools)
library(DiagrammeR)
library(DiagrammeRsvg)  # for conversion to svg
library(ivtools)
library(ggridges)
#devtools::install_github("davidsjoberg/ggsankey")
library(ggsankey)
library(gtsummary)
library(haven)
library(here)
#library(PRISMAstatement)
library(rsvg)  # for saving svg
library(tidymodels)
library(tidyverse)
library(viridis)


#library(MendelianRandomization, AER)
knitr::opts_chunk$set(echo = TRUE)
```

Load data - SAS
```{r, eval = FALSE}
rand = read_sas(here("data", "randhrs1992_2018v1.sas7bdat"), n_max = 10)
data = read_sas(here("data", "hrs_democoggen_wide20200910.sas7bdat"))
```

Load data - .Rda
```{r, eval = F}
load(here("data", "randhrs1992_2018v1.rda"))
saveRDS(randhrs1992_2018v1, here("data", "randhrs1992_2018v1"))

load(here("data", "hrs_democoggen_wide20200910.Rda"))
saveRDS(hrs0910, here("data", "hrs_democoggen_wide2020910.Rda"))
```

Load data
```{r, eval = F}
rand <- readRDS(here("data", "randhrs1992_2018v1"))
data <- readRDS(here("data", "hrs_democoggen_wide2020910.Rda"))
```

* ID
  + HHID: Household ID
  + PN: Person Number
  + Wave N is 2012
  + NIWWAVE indicator variable for interviewed during 2012 wave
  + R11 is 2012

* Outcome
  + AD12: cognitive exam at 2012 wave
  + COG_LAST_NS: Individual's last cognitive status, excluding those who had a stroke
  
* Exposure
  + R11DRINK: Ever drinks
  + R11DRINKD: When drinks, how many days/week
  + R11DRINKN: When drinks, how much per day
  + drinkpweek = R11DRINKD*R11DRINKN
  + everdrank = I(RxxDRINK == 1)
  
* Instrumental Variables
  + AA_PGS4_DPW_GSCAN19
  + EA_PGS4_DPW_GSCAN19

* Covariates
  + NAGE: 2012 Age
  + GENDER: sex
  + RACE: Race/ethnicity
  + DEGREE: Highest educational attainment
  + APOE012: APOE-e4 status
  + NMARST: 2012 Marital Status
  + R11CESD: 2012 CES-D score
  + R11CONDE: Number of comorbidities (0-8) for high blood pressure, diabetes,
    cancer, lung disease, heart disease, stroke, psychiatric problems,
    and arthritis, RAND Variable only
  + R11SAYRET: whether retired, RAND variable only
  + R11SMOKEV: smoked ever
  
* Ancestry-specific covariates
  + AAPC1_5A: [A-E], African ancestry genetic principal components (2006-2012)
  + EAPC1_5A: [A-E], European ancestry genetic principal components (2006-2012)
  
  + AA_PGS4_01AD2NA_IGAP19: African ancestry Alzheimer's w/o APOE, pT = 0.01 (IGAP 2019)
  + AA_PGS4_01AD2WA_IGAP19: African ancestry Alzheimer's w/ APOE, pT = 1 (IGAP 2019)
  

* Does not apply to cross-sectional:
  + Alcohol consumption at baseline
  + BIRTHYR: Birth year to control for cohort effects (why is 0 coded?)

* Other variables that may be of interest:
  + AGE_LAST_NS: Individual's last age, excluding those who had a stroke
  + NALIVE: vital status
  + APOE2010_BIN: presence of any e4 allele
  + R11BMI: Self-reported BMI
  + SMOKE12: current, former, or never smoker
  + R11SMOKEN: smokes now
  + Smoking variables (recall Jonah's analysis about DNAm and smoking)
  + WTCOHORT, "which gives the birth cohort used for calculating weights."

Add HHIDPN for merging with RAND data
```{r, eval = F}
data <- 
  data %>%
  mutate(HHIDPN = paste0(HHID, PN)) %>% 
  dplyr::select(HHIDPN, everything())
```

Reconstruct HHIDPN in RAND to avoid leading zero truncation and pull RAND variables of interest
```{r, eval = F}
rand.select <-
  rand %>%
  mutate(HHIDPN = paste0(HHID, PN)) %>%
  dplyr::select(HHIDPN, R11CONDE, R11SAYRET)
```

```{r, eval = F}
rm(rand)
```

Data preprocessing
```{r, eval = F}
dat.merged <-
  left_join(
    data,
    rand.select
  )
#saveRDS(dat.merged, file = here("data", "cross-sectional_data_2021-12-02.rda"))
```

# Covariate selection and variable formatting 
```{r}
dat.merged <- readRDS(here("data", "cross-sectional_data_2021-12-02.rda"))
```

## Formatting and inclusion/exclusion
```{r}
#Format variables of interest
source(here("scripts", "formatting_functions.r"))

dat <-
  dat.merged %>%
  filter(NIWWAVE == 1) %>% # limit to 2012 wave
  mutate(AD12 = factor_cog_lw(AD12)) %>% # format cognition variable
  mutate(drinkpweek = R11DRINKD * R11DRINKN) %>%
  mutate(logdrinkpweek = log1p(drinkpweek)) %>% # logtransform drinkpweek w/ 1p to account for 0s
  mutate(AD12.Dementia.outcome = fct_recode(# create dementia dummy variable
    .f = AD12,
    NULL = "CIND")) %>% 
  mutate(AD12.CIND.outcome = fct_recode(# create CIND dummy variable
    .f = AD12,
    NULL = "Dementia")) %>% 
  mutate(GENDER = factor_gender(GENDER)) %>%
  # Recode race not reported to missing
  mutate(RACE = ifelse(
    RACE == 0,
    NA,
    RACE
  )) %>%
  mutate(RACE = factor_race(RACE)) %>%
  mutate(DEGREE = factor_degree(DEGREE)) %>%
  mutate(DEGREE =
    case_when(
      DEGREE == "No degree" ~ "No degree",
      DEGREE %in% c("GED", "High School Diploma", "Degree Unknown/Some college") ~ "High school/GED/Some college",
      DEGREE %in% c("Two year college degree", "Four year college degree", "Master degree", "Professional Degree") ~ "Two year college degree or greater"
    )
  ) %>%
  #mutate(DEGREE = ordered(DEGREE, levels = c("No degree", "High school/GED/Some college", "Two year college degree or greater"))) %>%
  mutate(everdrank = sum(across(matches("R\\d+DRINK$")))) %>%
  mutate(R11DRINK = factor_ever_drink(R11DRINK)) %>%
  mutate(R11DRINKD = as.numeric(R11DRINKD)) %>%
  mutate(R11DRINKN = as.numeric(R11DRINKN)) %>%
    #R3DRINK | R4DRINK %>% # | R5DRINK | R6DRINK | R7DRINK | R8DRINK | R9DRINK | R10DRINK | R11DRINK) %>%
  mutate(APOE012 = factor_APOE_012(APOE012)) %>%
  mutate(AncestryPC_1_5A = case_when( # Combining ancestry pcs by race for inclusion/exclusion purposes
    RACE == "White/Caucasian" ~ eaPC1_5A,
    RACE == "Black or African American" ~ AAPC1_5A
  )) %>%
  mutate(AncestryPC_1_5B = case_when(
    RACE == "White/Caucasian" ~ eaPC1_5B,
    RACE == "Black or African American" ~ AAPC1_5B
  )) %>%
  mutate(AncestryPC_1_5C = case_when(
    RACE == "White/Caucasian" ~ eaPC1_5C,
    RACE == "Black or African American" ~ AAPC1_5C
  )) %>%
  mutate(AncestryPC_1_5D = case_when(
    RACE == "White/Caucasian" ~ eaPC1_5D,
    RACE == "Black or African American" ~ AAPC1_5D
  )) %>%
  mutate(AncestryPC_1_5E = case_when(
    RACE == "White/Caucasian" ~ eaPC1_5E,
    RACE == "Black or African American" ~ AAPC1_5E
  )) %>%
  mutate(PGS4_DPW_GSCAN19 = case_when(
    RACE == "White/Caucasian" ~ EA_PGS4_DPW_GSCAN19,
    RACE == "Black or African American" ~ AA_PGS4_DPW_GSCAN19
  )) %>%
  mutate(R11SMOKEV = factor_ever_smoke(R11SMOKEV)) %>%
  # Recode marital status not reported to missing
  mutate(NMARST = ifelse(
    NMARST == 5,
    NA,
    NMARST
  )) %>%
  mutate(NMARST = factor_marital_status(NMARST)) %>%
  mutate(R11SAYRET = factor_says_retired(R11SAYRET)) %>%
  mutate(across(.cols = everything(), ~ zap_label(.x))) %>%   # Remove labels, only necessary if using .sas7bdat
  mutate(across(.cols = everything(), ~ zap_formats(.x)))     # Remove formats, only necessary if using .sas7bdat
```

Code chunk to create categorized exposure category if desired
```{r, eval = F, include = F}
  mutate(drinkpweek.cut = factor(
    case_when(
      drinkpweek == 0 ~ "Never drinker",
      drinkpweek <= median(dat$drinkpweek[dat$drinkpweek!=0]) ~ "Low",
      drinkpweek > median(dat$drinkpweek[dat$drinkpweek!=0]) ~ "High"
  ))) %>%
```

## Covariates for consideration
Create a vector of variables for bivariate consideration and, separately, covariates. Order matters for gtsummary
```{r}
aa.pgs.covariates <- c("AAPC1_5A", "AAPC1_5B", "AAPC1_5C", "AAPC1_5D", "AAPC1_5E", "AA_PGS4_DPW_GSCAN19")
ea.pgs.covariates <- c("eaPC1_5A", "eaPC1_5B", "eaPC1_5C", "eaPC1_5D", "eaPC1_5E", "EA_PGS4_DPW_GSCAN19")
combined.pgs.covariates <- c("AncestryPC_1_5A", "AncestryPC_1_5B", "AncestryPC_1_5C", "AncestryPC_1_5D", "AncestryPC_1_5E", "PGS4_DPW_GSCAN19")

univariates = c("NAGE", "GENDER", "RACE", "DEGREE", "AD12", "drinkpweek",
                "R11DRINK", "R11DRINKD", "R11DRINKN", "APOE012",
                "R11SMOKEV", "NMARST", "R11CESD", "R11CONDE", "R11SAYRET",
                "EA_PGS4_DPW_GSCAN19", "AD12.CIND.outcome", "AD12.Dementia.outcome",
                "drinkpweek") #"drinkpweek.cut"
bivariates = c("NAGE", "GENDER", "RACE", "DEGREE", "drinkpweek", "PGS4_DPW_GSCAN19",
                "R11DRINK", "R11DRINKD", "R11DRINKN", "APOE012",
                "R11SMOKEV", "NMARST", "R11CESD", "R11CONDE", "R11SAYRET")
covariates = c("NAGE", "GENDER", "RACE", "DEGREE", "drinkpweek", "logdrinkpweek", "PGS4_DPW_GSCAN19",
                "APOE012", "R11SMOKEV", "NMARST", "R11CESD", "R11CONDE", "R11SAYRET")
```

## Analytic sample inclusion/exclusion flow chart
```{r}
wave.2012.count <- nrow(dat)

genetic.subsample <- 
  dat %>%
  filter(GENETICS06 == T | GENETICS08 == T | GENETICS10 == T) #|  GENETICS12 == T)
genetic.subsample.count <- nrow(genetic.subsample)

#genetic.subsample %>% drop_na(APOE012) %>% nrow

ancestry.subsample <- 
  genetic.subsample %>%
  filter(RACE == "White/Caucasian" | RACE == "Black or African American") %>%
  drop_na(AncestryPC_1_5A, AncestryPC_1_5B, AncestryPC_1_5C, AncestryPC_1_5D, AncestryPC_1_5E)
ancestry.count <- nrow(ancestry.subsample)

pgs.score <-
  genetic.subsample %>%
  drop_na(AncestryPC_1_5A, AncestryPC_1_5B, AncestryPC_1_5C, AncestryPC_1_5D, AncestryPC_1_5E, PGS4_DPW_GSCAN19)
pgs.score.count <- nrow(pgs.score)

#pgs.score %>%
#  dplyr::select(c("HHIDPN", "AncestryPC_1_5A", "AncestryPC_1_5B", "AncestryPC_1_5C", "AncestryPC_1_5D", "AncestryPC_1_5E", "PGS4_DPW_GSCAN19", "APOE012")) %>%
#  summarise(across(.fns = ~ sum(is.na(.x))))

outcome <-
  pgs.score %>%
  filter(!is.na(AD12))
outcome.count <- nrow(outcome)

exposure <-
  outcome %>%
  filter(!is.na(drinkpweek))
exposure.count <- nrow(exposure)

complete <-
  exposure %>%
  dplyr::select(HHIDPN, all_of(covariates), "AD12", "AD12.CIND.outcome", "AD12.Dementia.outcome") %>%
  drop_na(any_of(c(covariates)))
complete.count <- nrow(complete)
```

```{r}
complete$AD12.CIND.outcome %>% summary
complete$AD12.Dementia.outcome %>% summary
complete$AD12 %>% summary
```

Inclusion/exclusion chart
```{r}
dot <- flow_exclusions_dot(
  incl_counts = c(
    wave.2012.count,
    genetic.subsample.count,
    ancestry.count,
    pgs.score.count,
    outcome.count,
    exposure.count,
    complete.count),
  total_label = "Health and Retirement Study - 2012 Wave",
  incl_labels = c(
    "Genetic subsample",
    "African or European ancestry",
    "With drinks per week polygenic score",
    "With 2012 dementia assessment",
    "With 2012 alcohol exposure information",
    "Complete African or European ancestry observations"),
  excl_labels = c(
    "Missing genetic data",
    "Neither African nor European ancestry",
    "Without drinks per week polygenic score",
    "Missing 2012 dementia assessment",
    "Missing 2012 alcohol exposure information",
    "Missing any 2012 covariate information"),
  percent_of_total = TRUE
)
```

Save simpler inclusion/exclusion chart for presentation
```{r}
grViz_object = DiagrammeR::grViz(dot)
#grViz_object %>% export_svg() %>% charToRaw %>% rsvg_pdf(here("results", paste0("wave2012_incl_excl_", Sys.Date(), ".pdf")))
```

Loop through all covariates for detailed inclusion/exclusion
```{r}
covariate_counts <- vector(mode = "numeric")
dat_incl_excl <- exposure
for (i in covariates) {
  dat_incl_excl <-
    dat_incl_excl %>%
    filter(!is.na(!! rlang::sym(i)))
  covariate_counts <- append(covariate_counts, nrow(dat_incl_excl))
}
```

All covariates Inclusion/exclusion chart
```{r}
dot <- flow_exclusions_dot(
  incl_counts = c(
    wave.2012.count,
    genetic.subsample.count,
    ancestry.count,
    pgs.score.count,
    outcome.count,
    exposure.count,
    covariate_counts),
  total_label = "Health and Retirement Study - 2012 Wave",
  incl_labels = c(
    "Genetic subsample",
    "African or European ancestry",
    "With drinks per week polygenic score",
    "With 2012 dementia assessment",
    "With 2012 alcohol exposure information",
    covariates),
  excl_labels = c(
    "Missing genetic data",
    "Neither African nor European ancestry",
    "Without drinks per week polygenic score",
    "Missing 2012 dementia assessment",
    "Missing 2012 alcohol exposure information",
    covariates),
  percent_of_total = TRUE
)
```

Save large inclusion/exclusion chart
```{r}
grViz_object = grViz(dot)
#grViz_object %>% export_svg() %>% charToRaw %>% rsvg_pdf(here("results", paste0("wave2012_detailed_excl_", Sys.Date(), ".pdf")))
```

Get a complete dataset
```{r}
complete.vars <- c("HHIDPN", "AD12", covariates)
complete.vars.with.ancestry.pcs <- c("HHIDPN", "AD12", covariates, combined.pgs.covariates)

complete.data <-
  dat %>%
  dplyr::select(all_of(complete.vars.with.ancestry.pcs)) %>%
  filter(RACE == "White/Caucasian" | RACE == "Black or African American") %>%
  drop_na()
nrow(complete.data)
```

```{r}
#saveRDS(complete.data %>% pull(l), here("data", paste0(Sys.Date(), "_xs_poster_data.rda")))
```


## Sankey plots to assess alcohol consumption status over time {.tabset}

```{r}
dat.merged.complete <-
  dat.merged %>%
  filter(HHIDPN %in% complete.data$HHIDPN)
```

### Ever drinks - Cohort
```{r}
sk <- dat.merged %>%
  ggsankey::make_long(R3DRINK, R4DRINK, R5DRINK, R6DRINK, R7DRINK, R8DRINK, R9DRINK, R10DRINK, R11DRINK, R12DRINK)
sk.count <- dim(dat.merged)[[1]]
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Ever drinks - Cohort - ", sk.count, " individuals")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

### Ever drinks - Cohort, complete
```{r}
sk.count <- 
  dat.merged %>%
  drop_na(R3DRINK, R4DRINK, R5DRINK, R6DRINK, R7DRINK, R8DRINK, R9DRINK, R10DRINK, R11DRINK, R12DRINK) %>%
  dim
sk.count <- sk.count[[1]]
sk <- dat.merged %>%
  drop_na(R3DRINK, R4DRINK, R5DRINK, R6DRINK, R7DRINK, R8DRINK, R9DRINK, R10DRINK, R11DRINK, R12DRINK) %>%
  ggsankey::make_long(R3DRINK, R4DRINK, R5DRINK, R6DRINK, R7DRINK, R8DRINK, R9DRINK, R10DRINK, R11DRINK, R12DRINK)
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Ever drinks - Cohort - ", sk.count, " complete cases")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```
### Ever drinks - Analytic sample
```{r}
sk.count <- 
  dat.merged.complete %>%
  dim
sk.count <- sk.count[[1]]
sk <- dat.merged.complete %>%
  ggsankey::make_long(R3DRINK, R4DRINK, R5DRINK, R6DRINK, R7DRINK, R8DRINK, R9DRINK, R10DRINK, R11DRINK, R12DRINK)
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Ever drinks - Analytic Sample - ", sk.count, " individuals")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

### Ever drinks - Analytic sample, complete
```{r}
sk.count <- 
  dat.merged.complete %>%
  drop_na(R3DRINK, R4DRINK, R5DRINK, R6DRINK, R7DRINK, R8DRINK, R9DRINK, R10DRINK, R11DRINK, R12DRINK) %>%
  dim
sk.count <- sk.count[[1]]
sk <- dat.merged %>%
  drop_na(R3DRINK, R4DRINK, R5DRINK, R6DRINK, R7DRINK, R8DRINK, R9DRINK, R10DRINK, R11DRINK, R12DRINK) %>%
  ggsankey::make_long(R3DRINK, R4DRINK, R5DRINK, R6DRINK, R7DRINK, R8DRINK, R9DRINK, R10DRINK, R11DRINK, R12DRINK)
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Ever drinks - Analytic Sample - ", sk.count, " complete cases")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

```{r}
dat.merged.complete %>% select(matches("DRINK$")) %>% colnames
dat.merged.complete %>% select(matches("^AD\\d\\d")) %>% colnames
```
## {-}

## Sankey plots assess cognition trajectories {.tabset}
### Cognition - Cohort
```{r}
sk <- dat.merged %>%
  ggsankey::make_long(AD95, AD96, AD98, AD00, AD02, AD04, AD06, AD08, AD10, AD12, AD14)
sk.count <- dim(dat.merged)[[1]]
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Cognition - Cohort - ", sk.count, " individuals")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

### Cognition - Cohort, complete
```{r}
sk.count <- 
  dat.merged %>%
  drop_na(AD96, AD98, AD00, AD02, AD04, AD06, AD08, AD10, AD12, AD14) %>%
  dim
sk.count <- sk.count[[1]]
sk <- dat.merged %>%
  drop_na(AD96, AD98, AD00, AD02, AD04, AD06, AD08, AD10, AD12, AD14) %>%
  ggsankey::make_long(AD96, AD98, AD00, AD02, AD04, AD06, AD08, AD10, AD12, AD14)
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Cognition - Cohort - ", sk.count, " complete cases")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

### Cognition - Analytic sample
```{r}
sk.count <- 
  dat.merged.complete %>%
  dim
sk.count <- sk.count[[1]]
sk <- dat.merged.complete %>%
  ggsankey::make_long(AD95, AD96, AD98, AD00, AD02, AD04, AD06, AD08, AD10, AD12, AD14)
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Cognition status - Analytic Sample - ", sk.count, " individuals")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

### Cognition - Analytic sample, complete
```{r}
sk.count <- 
  dat.merged.complete %>%
  drop_na(AD96, AD98, AD00, AD02, AD04, AD06, AD08, AD10, AD12, AD14) %>%
  dim
sk.count <- sk.count[[1]]
sk <- dat.merged %>%
  drop_na(AD96, AD98, AD00, AD02, AD04, AD06, AD08, AD10, AD12, AD14) %>%
  ggsankey::make_long(AD96, AD98, AD00, AD02, AD04, AD06, AD08, AD10, AD12, AD14)
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Cognition - Analytic Sample - ", sk.count, " complete cases")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

## {-}

## Sankey plots to assess bivariate cognition and current ever drinks {.tabset}

### Ever drinks & cognition - cohort
```{r}
sk.count <- 
  dat.merged %>%
  dim
sk.count <- sk.count[[1]]
sk <- dat.merged %>%
  ggsankey::make_long(AD95, AD96, R3DRINK, AD98, R4DRINK, AD00, R5DRINK, AD02, R6DRINK, AD04, R7DRINK, AD06, R8DRINK, AD08, R9DRINK, AD10, R10DRINK, AD12, R11DRINK, AD14, R12DRINK)
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Ever drinks & cognition - Cohort - ", sk.count, " individuals")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

### Ever drinks & cognition - Cohort, complete
```{r}
sk.count <- 
  dat.merged %>%
  drop_na(AD96, R3DRINK, AD98, R4DRINK, AD00, R5DRINK, AD02, R6DRINK, AD04, R7DRINK, AD06, R8DRINK, AD08, R9DRINK, AD10, R10DRINK, AD12, R11DRINK, AD14, R12DRINK) %>%
  dim
sk.count <- sk.count[[1]]
sk <- dat.merged %>%
  drop_na(AD96, R3DRINK, AD98, R4DRINK, AD00, R5DRINK, AD02, R6DRINK, AD04, R7DRINK, AD06, R8DRINK, AD08, R9DRINK, AD10, R10DRINK, AD12, R11DRINK, AD14, R12DRINK) %>%
  ggsankey::make_long(AD96, R3DRINK, AD98, R4DRINK, AD00, R5DRINK, AD02, R6DRINK, AD04, R7DRINK, AD06, R8DRINK, AD08, R9DRINK, AD10, R10DRINK, AD12, R11DRINK, AD14, R12DRINK)
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Ever drinks & cognition - Cohort - ", sk.count, " complete cases")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

### Ever drinks - Analytic sample
```{r}
sk.count <- 
  dat.merged.complete %>%
  dim
sk.count <- sk.count[[1]]
sk <- dat.merged.complete %>%
  ggsankey::make_long(AD95, AD96, R3DRINK, AD98, R4DRINK, AD00, R5DRINK, AD02, R6DRINK, AD04, R7DRINK, AD06, R8DRINK, AD08, R9DRINK, AD10, R10DRINK, AD12, R11DRINK, AD14, R12DRINK)
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Ever drinks & cognition - Analytic Sample - ", sk.count, " individuals")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

### Ever drinks - Analytic sample, complete
```{r}
sk.count <- 
  dat.merged.complete %>%
  drop_na(AD96, R3DRINK, AD98, R4DRINK, AD00, R5DRINK, AD02, R6DRINK, AD04, R7DRINK, AD06, R8DRINK, AD08, R9DRINK, AD10, R10DRINK, AD12, R11DRINK, AD14, R12DRINK) %>%
  dim
sk.count <- sk.count[[1]]
sk <- dat.merged %>%
  drop_na(AD96, R3DRINK, AD98, R4DRINK, AD00, R5DRINK, AD02, R6DRINK, AD04, R7DRINK, AD06, R8DRINK, AD08, R9DRINK, AD10, R10DRINK, AD12, R11DRINK, AD14, R12DRINK) %>%
  ggsankey::make_long(AD96, R3DRINK, AD98, R4DRINK, AD00, R5DRINK, AD02, R6DRINK, AD04, R7DRINK, AD06, R8DRINK, AD08, R9DRINK, AD10, R10DRINK, AD12, R11DRINK, AD14, R12DRINK)
ggplot(sk, aes(x = x, next_x = next_x, node = node, next_node = next_node, fill = factor(node), label = node)) +
  geom_sankey(flow.alpha = .6,
              node.color = "gray30") +
  geom_sankey_label(size = 3, color = "white", fill = "gray40") +
  scale_fill_viridis_d() +
  theme_sankey(base_size = 18) +
  labs(x = NULL) +
  theme(legend.position = "none",
        plot.title = element_text(hjust = .5)) +
  ggtitle(paste0("Ever drinks - Analytic Sample - ", sk.count, " complete cases")) +
  scale_x_discrete(guide = guide_axis(n.dodge = 2))
```

## {-}

## Inclusion/exclusion comparison

Get a dataset with dummy selection variable
```{r}
included.ids <- complete.data$HHIDPN
included <-
  dat %>%
  filter(RACE == "White/Caucasian" | RACE == "Black or African American") %>%
  mutate(Included = ifelse(
    HHIDPN %in% included.ids,
    T,
    F
  )) %>%
  dplyr::select("Included", all_of(complete.vars))
```

## Tbl_summary
```{r}
tbl_summary_labels <-
  list(
      NAGE ~ "Age",
      GENDER ~ "Sex",
      RACE ~ "Race/ethnicity",
      DEGREE ~ "Education",
      AD12 ~ "Dementia classification",
      drinkpweek ~ "Drinks per week",
      PGS4_DPW_GSCAN19 ~ "Polygenic Risk Score",
      #logdrinkpweek ~ "Log-transformed drinks per week",
      #R11DRINK ~ "Ever drinks",
      #R11DRINKD ~ "How many days per week when drinking",
      #R11DRINKN ~ "Number of drinks per day when drinking",
      APOE012 ~ paste0("APOE-", "\U03B5", "4 allele count"),
      R11SMOKEV ~ "Ever smokes",
      NMARST ~ "Marital status",
      R11CESD ~ "CES-D depressive symptoms score",
      R11CONDE ~ "Number of comorbidities",
      R11SAYRET ~ "Retirement status"
      )

tbl_summary_types <-
  list( 
    #R11DRINKN ~ "continuous",
    #R11DRINKD ~ "continuous",
    R11CESD ~ "continuous",
    R11CONDE ~ "continuous"

  )
```

```{r}
dat.univar <-
  complete.data %>%
  #filter(HHIDPN %in% complete$HHIDPN) %>%
  dplyr::select(all_of(complete.vars)) %>%
  dplyr::select(-HHIDPN)
```

# Univariate Table
```{r}
dat.univar %>%
  tbl_summary(
    label = tbl_summary_labels,
    type = tbl_summary_types
    )
```

# Bivariate Table
```{r}
bivar.table <- dat.univar %>%
  dplyr::select(!logdrinkpweek) %>%
  tbl_summary(
    by = "AD12",
    label = tbl_summary_labels,
    type = tbl_summary_types) %>%
  add_n() %>%
  add_p()
bivar.table

#bivar.table %>% as_flex_table %>% save_as_image(path = here("results", paste0(Sys.Date(), "_bivar.png")))
```

Included/excluded bivariate table
```{r}
tbl_summary_labels_included <- append(tbl_summary_labels, Included ~ "Included with complete data")

included %>%
  dplyr::select(!HHIDPN) %>%
  tbl_summary(
    by = "Included",
    label = tbl_summary_labels_included,
    type = tbl_summary_types) %>%
  add_n() %>%
  add_p()
```

# Univariate Distributions
Function to run univariate plots
```{r}
# Get names of numeric variables
dat.univar.numeric <-
  dat.univar %>%
  dplyr::select(where(is.numeric)) %>%
  names
# Histogram function
histogram.univar <- function(var) {
  ggplot(data = dat,
         mapping = aes_string(x = var)
         ) + 
    geom_histogram(na.rm = TRUE) +
    ggtitle(var) +
    theme_bw()
}
# plot
map(dat.univar.numeric, ~ histogram.univar(.x))
```

```{r}
ggplot(data = dat.merged.complete,
       mapping = aes(
         x = NAGE,
         fill = AD12
       )) +
  geom_histogram(alpha = 0.7) +
  facet_grid(rows = vars(AD12), cols = vars(R11DRINK)) +
  ggtitle("Ever drinker status accelerates dementia onset?")
```

```{r}
ggplot(data = dat.merged.complete,
       mapping = aes(
         x = NAGE,
         fill = AD12
       )) +
  geom_density(alpha = 0.7) +
  facet_grid(rows = vars(AD12), cols = vars(R11DRINK)) +
  ggtitle("Ever drinker status accelerates dementia onset?")
```

```{r}
ggplot(data = dat.univar,
       mapping = aes(
         x = NAGE,
         y = drinkpweek
       )) +
  geom_rug() +
  geom_hex() +
  facet_grid(cols = vars(AD12)) +
  ggtitle("Drinks per week by dementia status")
```

```{r, eval = F}
ggplot(data = dat.univar,
       mapping = aes(
         x = NAGE,
         fill = AD12
       )) +
  geom_histogram(alpha = 0.7) +
  facet_grid(rows = vars(AD12), cols = vars(drinkpweek.cut)) +
  ggtitle("Drinking status accelerates dementia onset?")
```


```{r, eval = F}
ggplot(data = dat.univar,
       mapping = aes(
         x = NAGE,
         fill = AD12
       )) +
  geom_density(alpha = 0.7) +
  facet_grid(rows = vars(AD12), cols = vars(drinkpweek.cut)) +
  ggtitle("Drinking status accelerates dementia onset?")
```

# Logit cross-sectional

## Set model covariates
```{r}
model.covariates <- covariates[!(covariates %in% c("logdrinkpweek", "PGS4_DPW_GSCAN19"))]
```


```{r}
logit.dementia <-
  glm(formula =
          as.formula(
            paste0(
              "AD12.Dementia.outcome ~ ",
              paste(model.covariates, collapse = " + ")
              ),
            ),
      data = dat,
      family = "binomial"
  )
summary(logit.dementia)

t.dementia <- tbl_regression(logit.dementia, exponentiate = TRUE)
t.dementia

logit.dementia.tidy <- tidy(logit.dementia, conf.int = TRUE, exponentiate = TRUE)
logit.dementia.tidy$model <- "Dementia"
```

```{r, results='hide'}
logit.cind <-
  glm(formula =
          as.formula(
            paste0(
              "AD12.CIND.outcome ~ ",
              paste(model.covariates, collapse = " + ")
              ),
            ),
      data = dat,
      family = "binomial"
  )
summary(logit.cind)

t.cind <- tbl_regression(logit.cind, exponentiate = TRUE)
t.cind

logit.cind.tidy <- tidy(logit.cind, conf.int = TRUE, exponentiate = TRUE)
logit.cind.tidy$model <- "CIND"
```

```{r}
# merge tables 
tbl_merge_ex1 <-
  tbl_merge(
    tbls = list(t.cind, t.dementia),
    tab_spanner = c("**CIND**", "**Dementia**")
  )
tbl_merge_ex1
```

```{r}
dat.forest <- rbind(logit.dementia.tidy, logit.cind.tidy)
```

```{r}
forest <- ggplot(data=dat.forest,
                 aes(
                   x=term,
                   y=estimate,
                   ymin=conf.low,
                   ymax=conf.high,
                   color = model,
                   fill = model)) +
  geom_hline(yintercept = 1, linetype = 2) +
  geom_pointrange(position=position_dodge(width = 1)) +
  coord_cartesian(ylim = c(0, 2.5)) +
  coord_flip() +
  theme_bw()
forest
```


```{r}
forest <- ggplot(data=dat.forest %>% filter(term == "drinkpweek"),
                 aes(
                   x=term,
                   y=estimate,
                   ymin=conf.low,
                   ymax=conf.high,
                   color = model,
                   fill = model)) +
  geom_hline(yintercept = 1, linetype = 2) +
  geom_pointrange(position=position_dodge(width = 1)) +
  coord_cartesian(ylim = c(0, 2.5)) +
  coord_flip() +
  theme_bw()
forest
```

# MR
* IV estimation of CRR and COR in MR analyses https://pubmed.ncbi.nlm.nih.gov/21555716/
  + 2SLS with binary outcome provides biased results; need to estimation g-estimation (residual integration)
* ivtools R package publication: https://www.degruyter.com/document/doi/10.1515/em-2018-0024/html
  + ivtools provides this functionality

European ancestry dataset
```{r}
dat.complete <- dat %>%
  filter(HHIDPN %in% complete$HHIDPN)
dat.ea.only <- 
  dat.complete %>%
  filter(RACE == "White/Caucasian")
dat.ea <-
  dat.ea.only %>%
  mutate(drinkpweek.cut = factor(
    case_when(
      drinkpweek == 0 ~ "Never drinker",
      drinkpweek <= median(dat.ea.only$drinkpweek[dat.ea.only$drinkpweek!=0]) ~ "Low",
      drinkpweek > median(dat.ea.only$drinkpweek[dat.ea.only$drinkpweek!=0]) ~ "High"
  ))) %>%
  drop_na(any_of(c(covariates, "EA_PGS4_DPW_GSCAN19", "AD12.CIND.outcome"))) %>% # WILL NEED TO CHANGE FOR AD12.DEMENTIA
  as.data.frame()
# Set Never drinker as reference level for drinkpweek cut
dat.ea$drinkpweek.cut <- relevel(dat.ea$drinkpweek.cut, ref = "Never drinker")
nrow(dat.ea)
summary(dat.ea$AD12.CIND.outcome)
```

Exploring associations between outcome, exposure, and genetic instrument
```{r}
dat.ea %>%
  dplyr::select(all_of(c(complete.vars, "drinkpweek.cut", "EA_PGS4_DPW_GSCAN19"))) %>%
  dplyr::select(-HHIDPN) %>%
  tbl_summary(
    by = "drinkpweek.cut",
    label = tbl_summary_labels,
    type = tbl_summary_types) %>%
  add_n() %>%
  add_p()
```

Exploring associations between outcome, exposure, and genetic instrument
Possible solution to error: https://stackoverflow.com/questions/61360954/error-in-add-p-for-variable-x-and-test-fisher-test-p-value-omitted
```{r}
dat.ea %>%
  dplyr::select(all_of(c(complete.vars, "drinkpweek.cut", "EA_PGS4_DPW_GSCAN19"))) %>%
  dplyr::select(-HHIDPN) %>%
  tbl_summary(
    by = "AD12",
    label = tbl_summary_labels,
    type = tbl_summary_types) %>%
  add_n() %>%
  add_p(simulate.p.value = T)
``` 

African ancestry dataset
```{r}
dat.complete <- dat %>%
  filter(HHIDPN %in% complete$HHIDPN)
dat.aa.only <- 
  dat.complete %>%
  filter(RACE == "Black or African American")
dat.aa <-
  dat.aa.only %>%
  mutate(drinkpweek.cut = factor(
    case_when(
      drinkpweek == 0 ~ "Never drinker",
      drinkpweek <= median(dat.aa.only$drinkpweek[dat.aa.only$drinkpweek!=0]) ~ "Low",
      drinkpweek > median(dat.aa.only$drinkpweek[dat.aa.only$drinkpweek!=0]) ~ "High"
  ))) %>%
  drop_na(any_of(c(covariates, "aa_PGS4_DPW_GSCAN19", "AD12.CIND.outcome"))) %>% # WILL NEED TO CHANGE FOR AD12.DEMENTIA
  as.data.frame()
# Set Never drinker as reference level for drinkpweek cut
dat.aa$drinkpweek.cut <- relevel(dat.aa$drinkpweek.cut, ref = "Never drinker")
```

## Two-stage least squares
### CIND vs. normal
TSLS - CIND
```{r}
fitY.LX <- glm(formula=AD12.CIND.outcome~drinkpweek, family="binomial", data=dat.ea)
summary(fitY.LX)
```


```{r}
fitX.LZ <- glm(formula=drinkpweek~EA_PGS4_DPW_GSCAN19, family="gaussian", data=dat.ea)
summary(fitX.LZ)
```

```{r}
fitIV_ts <- ivglm(estmethod="ts", fitX.LZ=fitX.LZ, fitY.LX=fitY.LX, data=dat.ea, ctrl = FALSE)
summary(fitIV_ts)
confint(fitIV_ts)
```

```{r}
fitIV_ts <- ivglm(estmethod="ts", fitX.LZ=fitX.LZ, fitY.LX=fitY.LX, data=dat.ea, ctrl = TRUE)
summary(fitIV_ts)
confint(fitIV_ts)
```

### Dementia vs. normal
TSLS - Dementia
```{r}
fitY.LX <- glm(formula=AD12.Dementia.outcome~drinkpweek, family="binomial", data=dat.ea)
summary(fitY.LX)
```

```{r}
fitX.LZ <- glm(formula=drinkpweek~EA_PGS4_DPW_GSCAN19, family="gaussian", data=dat.ea)
summary(fitX.LZ)
```

```{r}
fitIV_ts <- ivglm(estmethod="ts", fitX.LZ=fitX.LZ, fitY.LX=fitY.LX, data=dat.ea, ctrl = FALSE)
summary(fitIV_ts)
confint(fitIV_ts)
```

```{r}
fitIV_ts <- ivglm(estmethod="ts", fitX.LZ=fitX.LZ, fitY.LX=fitY.LX, data=dat.ea, ctrl = TRUE)
summary(fitIV_ts)
confint(fitIV_ts)
```

## G-estimation

Custom function to summarize ivglm output
```{r}
# Function accepts a fitted ivglm model and outputs tidy-formatted summary tibble with exponentiated effect estimate and 95% CIs
tidy_ivglm_summary <- function(mod) {
  summary <- summary(mod)
  tibble(
    term = attr(summary$coefficients, "dimnames")[[1]],
    estimate = round(exp(summary$coefficients[1]), 2),
    std.error = round(summary$coefficients[2], 2),
    statistic = round(summary$coefficients[3], 2),
    p.value = round(summary$coefficients[4], 2),
    conf.low = round(exp(confint(mod)[[1]]), 2),
    conf.high = round(exp(confint(mod)[[2]]), 2)
  )
}
```

### CIND vs. Normal, EA 
Provides unbiased OR estimates
```{r}
nrow(dat.ea)
summary(dat.ea$AD12.CIND.outcome)
```


```{r}
fitZ.L   <- glm(formula = EA_PGS4_DPW_GSCAN19 ~ 1,
              family = "gaussian", data = dat.ea)
summary(fitZ.L)

fitY.LZX <- glm(formula = AD12.CIND.outcome ~ EA_PGS4_DPW_GSCAN19 + drinkpweek,
                family = "binomial", data = dat.ea)
summary(fitY.LZX)


fitIV_g  <- ivglm(estmethod = "g", X = "drinkpweek", fitZ.L = fitZ.L, fitY.LZX = fitY.LZX,
                  data = dat.ea, link = "logit")
summary(fitIV_g)

g.cind.ea.tidy <- tidy_ivglm_summary(fitIV_g)
g.cind.ea.tidy$outcome <- "CIND"
g.cind.ea.tidy$sample <- "European ancestry"
```

### Dementia vs. Normal, EA

```{r}
dat.ea.g.dementia <-
  dat.ea.only %>%
  drop_na(any_of(c(covariates, "EA_PGS4_DPW_GSCAN19", "AD12.Dementia.outcome"))) %>%
  as.data.frame()
nrow(dat.ea.g.dementia)
```

```{r}
summary(dat.ea.g.dementia$AD12.Dementia.outcome)
```


```{r}
fitZ.L <- glm(formula = EA_PGS4_DPW_GSCAN19 ~ 1,
              family = "gaussian", data = dat.ea.g.dementia)
summary(fitZ.L)

fitY.LZX <- glm(formula = AD12.Dementia.outcome ~ EA_PGS4_DPW_GSCAN19 + drinkpweek,
                family = "binomial", data = dat.ea.g.dementia)
summary(fitY.LZX)

fitIV_g  <- ivglm(estmethod = "g", X = "drinkpweek", fitZ.L = fitZ.L, fitY.LZX = fitY.LZX,
                  data = dat.ea.g.dementia, link = "logit")

g.dem.ea.tidy <- tidy_ivglm_summary(fitIV_g)
g.dem.ea.tidy$outcome <- "Dementia"
g.dem.ea.tidy$sample <- "European ancestry"
```

```{r, eval = F}
fitZ.L <- glm(formula = EA_PGS4_DPW_GSCAN19 ~ AncestryPC_1_5A + AncestryPC_1_5B + AncestryPC_1_5C + AncestryPC_1_5D + AncestryPC_1_5E,
              family = "gaussian", data = dat.ea.g.dementia)
summary(fitZ.L)

fitY.LZX <- glm(formula = AD12.Dementia.outcome ~ EA_PGS4_DPW_GSCAN19 + drinkpweek + AncestryPC_1_5A + AncestryPC_1_5B + AncestryPC_1_5C + AncestryPC_1_5D + AncestryPC_1_5E,
                family = "binomial", data = dat.ea.g.dementia)
summary(fitY.LZX)

fitIV_g  <- ivglm(estmethod = "g", X = "drinkpweek", fitZ.L = fitZ.L, fitY.LZX = fitY.LZX,
                  data = dat.ea.g.dementia, link = "logit")

g.dem.ea.tidy <- tidy_ivglm_summary(fitIV_g)
g.dem.ea.tidy$outcome <- "Dementia"
g.dem.ea.tidy$sample <- "European ancestry"
```

### CIND vs. Normal, AA 
Provides unbiased OR estimates
```{r}
nrow(dat.aa)
summary(dat.aa$AD12.CIND.outcome)
```


```{r}
fitZ.L   <- glm(formula = AA_PGS4_DPW_GSCAN19 ~ 1,
              family = "gaussian", data = dat.aa)
summary(fitZ.L)

fitY.LZX <- glm(formula = AD12.CIND.outcome ~ AA_PGS4_DPW_GSCAN19 + drinkpweek,
                family = "binomial", data = dat.aa)
summary(fitY.LZX)


fitIV_g  <- ivglm(estmethod = "g", X = "drinkpweek", fitZ.L = fitZ.L, fitY.LZX = fitY.LZX,
                  data = dat.aa, link = "logit")
summary(fitIV_g)

g.cind.aa.tidy <- tidy_ivglm_summary(fitIV_g)
g.cind.aa.tidy$outcome <- "CIND"
g.cind.aa.tidy$sample <- "African ancestry"
```

### Dementia vs. Normal, AA

```{r}
dat.aa.g.dementia <-
  dat.aa.only %>%
  drop_na(any_of(c(covariates, "AA_PGS4_DPW_GSCAN19", "AD12.Dementia.outcome"))) %>%
  as.data.frame()
nrow(dat.aa.g.dementia)
```

```{r}
summary(dat.aa.g.dementia$AD12.Dementia.outcome)
```

```{r}
fitZ.L <- glm(formula = AA_PGS4_DPW_GSCAN19 ~ 1,
              family = "gaussian", data = dat.aa.g.dementia)
summary(fitZ.L)

fitY.LZX <- glm(formula = AD12.Dementia.outcome ~ AA_PGS4_DPW_GSCAN19 + drinkpweek,
                family = "binomial", data = dat.aa.g.dementia)
summary(fitY.LZX)

fitIV_g  <- ivglm(estmethod = "g", X = "drinkpweek", fitZ.L = fitZ.L, fitY.LZX = fitY.LZX,
                  data = dat.aa.g.dementia, link = "logit")

g.dem.aa.tidy <- tidy_ivglm_summary(fitIV_g)
g.dem.aa.tidy$outcome <- "Dementia"
g.dem.aa.tidy$sample <- "African ancestry"
```

### Graphing g-estimation odds ratio PGS MR results stratified by ancestry

Collect model results into one tibble
```{r}
g.forest <- rbind(g.cind.ea.tidy, g.dem.ea.tidy, g.cind.aa.tidy, g.dem.aa.tidy)
```

Forest plot
```{r}
forest <- ggplot(data=g.forest,
                 aes(
                   x=stringr::str_wrap(sample, 10),
                   y=estimate,
                   ymin=conf.low,
                   ymax=conf.high,
                   shape = outcome,
                   color = outcome)) +
  xlab("") +
  ylab("Odds Ratio Per 1 Drink Per Week Increase") +
  labs(shape = "Outcome", color = "Outcome") +
  geom_hline(yintercept = 1, linetype = 2) +
  geom_pointrange(position=position_dodge(width = 1)) +
  coord_cartesian(ylim = c(0, 2.5)) +
  coord_flip() +
  theme_bw() +
  theme(text = element_text(size = 18))
forest
#ggsave(here("results", "xs_g_est_alcohol_pgs_by_ancestry.png"))
```

