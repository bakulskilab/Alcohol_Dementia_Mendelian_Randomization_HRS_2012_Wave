---
title: "hrs2012_1smr_ind"
author: "Kyle Abraham Campbell"
date: '2022-07-26'
output: html_document
---

```{r setup, include=FALSE}
library(boot)
library(formulaic)
library(ivtools)
library(knitr)
library(gtsummary) 
library(here)
library(parameters)
library(MendelianRandomization)
library(readxl)
library(tidymodels)
library(tidyverse)

#library(devtools)
#library(remotes)
#remotes::install_github("qingyuanzhao/mr.raps")
library(mr.raps)
#devtools::install_github("WSpiller/RadialMR")
library(RadialMR)
#devtools::install_github("explodecomputer/tryx")
library(tryx)
#remotes::install_github("MRCIEU/TwoSampleMR")
#library(TwoSampleMR)
#install_github("tye27/mr.genius")
library(mr.genius)

knitr::opts_chunk$set(echo = TRUE)
```

as.data.frame is ESSENTIAL for ivglm to accept these as valid data inputs, if using
```{r}
dat <- readRDS(here("data", "analytic", "2022-07-25.gscan.dpw.1smr.xs.rda")) %>% as_tibble(.name_repair = "universal")

#dat.ea <- readRDS(here("data", "analytic", "2022-07-25.gscan.dpw.1smr.xs.rda")) %>% filter(RACE == "White/Caucasian") %>%  as.data.frame()
#dat.aa <- readRDS(here("data", "analytic", "2022-07-25.gscan.dpw.1smr.xs.rda")) %>% filter(RACE == "Black or African American") %>% as.data.frame()
```

Get SNP IDs
```{r}
variants <-
  dat %>%
  # This approaches assumes the SNP name still includes :'s
  #dplyr::select(matches(":\\D:\\D")) %>%
  dplyr::select(matches("\\.\\D\\.\\D")) %>%
  colnames()
```

```{r}
univariates = c("HHIDPN", "NAGE", "GENDER", "RACE", "DEGREE", "AD12", "drinkpweek", "logdrinkpweek",
                "R11DRINK", "R11DRINKD", "R11DRINKN", "APOE012",
                "R11SMOKEV", "NMARST", "R11CESD", "R11CONDE", "R11SAYRET",
                "PGS4_DPW_GSCAN19", "pgs.norm", "AD12.CIND.outcome", "AD12.Dementia.outcome", "AD12.binary") 
combined.pgs.covariates <- c("AncestryPC_1_5A", "AncestryPC_1_5B", "AncestryPC_1_5C", "AncestryPC_1_5D", "AncestryPC_1_5E")

model.vars <- c(univariates, combined.pgs.covariates, variants) %>% unique()
genetics <- c("PGS4_DPW_GSCAN19", "pgs.norm", variants)
```


```{r}
dat <-
  dat %>%
  dplyr::select(all_of(model.vars)) %>%
  mutate(AD12.binary = factor(AD12.binary))
```

Option to convert to long format with SNP as a single column
```{r, eval = F, include = F}
dat.long <-
  dat %>%
  pivot_longer(all_of(c(variants, "PGS4_DPW_GSCAN19", "pgs.norm")), names_to = "SNP", values_to = "Dosage")
```

```{r}
dat.ea <- dat %>% filter(RACE == "White/Caucasian")
dat.aa <- dat %>% filter(RACE == "Black or African American")
```

## Mendelian Randomization tests of instrument strength, independence, and exlcusion restriction assumptions

### European Ancestry - Exposure-Genetic Assocation

Set linear regression model
```{r}
lm_mod <-
  linear_reg()
```

Set logistic regression model
```{r}
lr_mod <- 
  logistic_reg() %>% 
  set_engine("glm")
```

Nest data by RACE and SNP
```{r, eval = F, include = F}
nested <-
  dat.long %>%
  group_by(RACE) %>%
  as_tibble() %>%
  nest(data = c(SNP))
```

```{r, eval = F, include = F}
nested %>%
  mutate(fit = map(data, ~ glm(family = binomial, formula = AD12.Dementia.outcome ~ SNP, data = .x)),
         tidied = map(fit, tidy)
  ) %>%
  unnest(tidied) %>%
  dplyr::select(-data, -fit)
```

### Fit Instrument -> Exposure model in EA
```{r}
# Fit the linear model across all instruments
fit <-
  map(
    .x = genetics,
    .f = ~ lm_mod %>%
      fit(formula(paste0("drinkpweek ~ ", .x)),
          data = dat.ea)
  )

fit_res <- map2(fit, genetics, ~ tidy(.x) %>% filter(term == .y))
names(fit_res) <- genetics
fit_res_df <- bind_rows(fit_res, .id = "Instrument")

fit_glance <- map(fit, ~ glance(.x))
names(fit_glance) <- genetics
fit_glance_df <- bind_rows(fit_glance, .id = "Instrument") %>% rename("F.stat" = statistic, "F.p.value" = p.value)

fit_all <- left_join(fit_res_df, fit_glance_df, by = "Instrument")
```

### Fit Instrument -> Outcome Dementia model in EA
Warning: glm.fit: fitted probabilities numerically 0 or 1 occurred, 22 times
```{r}
fit <-
  map(
    .x = genetics,
    .f = ~ lr_mod %>%
      fit(formula(paste0("AD12.Dementia.outcome ~ ", .x)),
          data = dat.ea)
  )

fit_res <- map2(fit, genetics, ~ tidy(.x, conf.int = TRUE, exponentiate = TRUE) %>% filter(term == .y))
names(fit_res) <- genetics
fit_res_df <- bind_rows(fit_res, .id = "Instrument")

fit_glance <- map(fit, ~ glance(.x))
names(fit_glance) <- genetics
fit_glance_df <- bind_rows(fit_glance, .id = "Instrument") #%>% rename("F.stat" = statistic, "F.p.value" = p.value)

fit_all <- left_join(fit_res_df, fit_glance_df, by = "Instrument")

res.dementia.ea <- fit_all
```

### Fit Instrument -> Outcome CIND model in EA
```{r}
fit <-
  map(
    .x = genetics,
    .f = ~ lr_mod %>%
      fit(formula(paste0("AD12.CIND.outcome ~ ", .x)),
          data = dat.ea)
  )

fit_res <- map2(fit, genetics, ~ tidy(.x, conf.int = TRUE, exponentiate = TRUE) %>% filter(term == .y))
names(fit_res) <- genetics
fit_res_df <- bind_rows(fit_res, .id = "Instrument")

fit_glance <- map(fit, ~ glance(.x))
names(fit_glance) <- genetics
fit_glance_df <- bind_rows(fit_glance, .id = "Instrument") #%>% rename("F.stat" = statistic, "F.p.value" = p.value)

fit_all <- left_join(fit_res_df, fit_glance_df, by = "Instrument")

res.cind.ea <- fit_all %>%
  mutate(Ancestry = "European Ancestry")
```

### Fit covariate -> instrument
```{r}
independent.vars <- c("DEGREE", "APOE012", "R11SMOKEV", "NMARST", "R11CESD", "R11CONDE", "R11SAYRET", "AncestryPC_1_5A", "AncestryPC_1_5B", "AncestryPC_1_5C", "AncestryPC_1_5D", "AncestryPC_1_5E")
```

```{r}
genetics.enum <- rep(genetics, times = length(independent.vars))
independent.vars.enum <- rep(independent.vars, times = length(genetics))
```

```{r}
# Fit the linear model across all instrument and covariate combinations for F-test
fit <-
  map2(
    .x = genetics.enum,
    .y = independent.vars.enum,
    .f = ~ lm_mod %>%
      fit(formula(paste0(.x, " ~ ", .y)),
          data = dat.ea)
  )

#fit_res <- map2(fit, genetics, ~ tidy(.x) %>% filter(term == .y))
#names(fit_res) <- genetics
#fit_res_df <- bind_rows(fit_res, .id = "Instrument")

# Collect the results into a data frame
# Add FDR-adjusted p-value
fit_glance <- map(fit, ~ glance(.x))
names(fit_glance) <- paste0(genetics.enum, "+", independent.vars.enum)
fit_glance_df <-
  bind_rows(fit_glance, .id = "Instrument") %>%
  rename("F.stat" = statistic, "F.p.value" = p.value) %>%
  mutate(F.p.value.fdr = p.adjust(F.p.value, method = "fdr")) %>%
  rowwise() %>%
  mutate(predictor = strsplit(Instrument,"+", fixed = T)[[1]][2]) %>%
  mutate(Instrument = strsplit(Instrument,"+", fixed = T)[[1]][1]) %>%
  dplyr::select(Instrument, predictor, everything())

#fit_all <- left_join(fit_res_df, fit_glance_df, by = "Instrument")
```

```{r}
fit_glance_df %>% group_by(Instrument) %>% filter(F.p.value < 0.05) %>% tally()
fit_glance_df %>% group_by(Instrument) %>% filter(F.p.value.fdr < 0.05) %>% tally()
fit_glance_df %>% group_by(Instrument) %>% filter(F.p.value < 0.05) %>% tally() %>% pull(n) %>% hist
fit_glance_df %>% group_by(Instrument) %>% filter(F.p.value.fdr < 0.05) %>% tally() %>% pull(n) %>% hist
```

```{r}
fit_glance_df %>% group_by(predictor) %>% filter(F.p.value < 0.05) %>% tally()
fit_glance_df %>% group_by(predictor) %>% filter(F.p.value.fdr < 0.05) %>% tally()
```

Most associations were for the ancestry PCs
```{r}
#View(fit_glance_df %>% filter(F.p.value < 0.05))
#View(fit_glance_df %>% filter(F.p.value.fdr < 0.05))
```

# MendelianRandomization R package for IV estimation and robust senstivity analyses of pleiotropy

```{r}
formula(paste0("drinkpweek ~ ", .x, " + ", paste(combined.pgs.covariates, collapse = " + ")))
```

### Fit Instrument -> Exposure model in EA
```{r}
# Drop the PGS scores
snps <- genetics[-seq(1,2)]
# Fit the linear model across all instruments, adjusted for ancestry covars
fit <-
  map(
    .x = snps,
    .f = ~ lm_mod %>%
      fit(formula(paste0("drinkpweek ~ ", .x, " + ", paste(combined.pgs.covariates, collapse = " + "))),
          data = dat.ea)
  )

fit_res <- map2(fit, snps, ~ tidy(.x) %>% filter(term == .y))
names(fit_res) <- snps
fit_res_df <- bind_rows(fit_res, .id = "Instrument")

fit_glance <- map(fit, ~ glance(.x))
names(fit_glance) <- snps
fit_glance_df <- bind_rows(fit_glance, .id = "Instrument") %>% rename("F.stat" = statistic, "F.p.value" = p.value)

fit_all <- left_join(fit_res_df, fit_glance_df, by = "Instrument")

bx <- fit_all$estimate
bxse <- fit_all$std.error
```

### Fit Instrument -> Outcome CIND model in EA
```{r}
fit <-
  map(
    .x = snps,
    .f = ~ lr_mod %>%
      fit(formula(paste0("AD12.CIND.outcome ~ ", .x, " + ", paste(combined.pgs.covariates, collapse = " + "))),
          data = dat.ea)
  )

fit_res <- map2(fit, snps, ~ tidy(.x, conf.int = TRUE, exponentiate = FALSE) %>% filter(term == .y))
names(fit_res) <- snps
fit_res_df <- bind_rows(fit_res, .id = "Instrument")

fit_glance <- map(fit, ~ glance(.x))
names(fit_glance) <- snps
fit_glance_df <- bind_rows(fit_glance, .id = "Instrument") #%>% rename("F.stat" = statistic, "F.p.value" = p.value)

fit_all <- left_join(fit_res_df, fit_glance_df, by = "Instrument")

res.cind.ea <- fit_all %>%
  mutate(Ancestry = "European Ancestry")

by <- fit_all$estimate
byse <- fit_all$std.error
```

```{r}
MRInputObject <- 
  mr_input(bx = bx,
           bxse = bxse,
           by = by,
           byse = byse)
```

```{r}
MRAllObject_all <- mr_allmethods(MRInputObject, method = "all")
```

```{r}
MRAllObject_all
```

Interactive plot, don't want to render into .html
```{r, include = F, eval = F}
mr_plot(MRInputObject,
error = TRUE, orientate = FALSE, line = "ivw")
```

```{r}
mr_plot(MRInputObject,
error = TRUE, orientate = FALSE, line = "ivw", interactive = F)
```

# Dementia EA indivdual 1smr

### Fit Instrument -> Outcome CIND model in EA; exposure model remains the same
```{r}
fit <-
  map(
    .x = snps,
    .f = ~ lr_mod %>%
      fit(formula(paste0("AD12.Dementia.outcome ~ ", .x, " + ", paste(combined.pgs.covariates, collapse = " + "))),
          data = dat.ea)
  )

fit_res <- map2(fit, snps, ~ tidy(.x, conf.int = TRUE, exponentiate = FALSE) %>% filter(term == .y))
names(fit_res) <- snps
fit_res_df <- bind_rows(fit_res, .id = "Instrument")

fit_glance <- map(fit, ~ glance(.x))
names(fit_glance) <- snps
fit_glance_df <- bind_rows(fit_glance, .id = "Instrument") #%>% rename("F.stat" = statistic, "F.p.value" = p.value)

fit_all <- left_join(fit_res_df, fit_glance_df, by = "Instrument")

res.dementia.ea <- fit_all %>%
  mutate(Ancestry = "European Ancestry")

by <- fit_all$estimate
byse <- fit_all$std.error
```

```{r}
MRInputObject <- 
  mr_input(bx = bx,
           bxse = bxse,
           by = by,
           byse = byse)
```

```{r}
MRAllObject_all <- mr_allmethods(MRInputObject, method = "all")
```

```{r}
MRAllObject_all
```

Interactive plot, don't want to render into .html
```{r, include = F}
mr_plot(MRInputObject,
error = TRUE, orientate = FALSE, line = "ivw")
```

```{r}
mr_plot(MRInputObject,
error = TRUE, orientate = FALSE, line = "ivw", interactive = F)
```


